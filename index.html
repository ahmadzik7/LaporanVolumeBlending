<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Input Volume Blending - Per Sheet</title>
  <style>
    :root {
      --bg: #121212;
      --card: #1e1e1e;
      --text: #ffffff;
      --primary: #2858dd;
      --accent: #bbdefb;
      --border: #333;
      --hover: #2a2a2a;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: var(--bg);
      color: var(--text);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 15px;
      background: linear-gradient(135deg, var(--primary), #1b5e20);
      border-radius: 8px;
    }
    h1 {
      font-size: 1.8rem;
      font-weight: bold;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--accent);
    }
    input, select {
      width: 100%;
      padding: 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 16px;
      transition: all 0.2s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(187, 222, 251, 0.2);
    }
    input[readonly] {
      background: #2a2a2a;
      cursor: not-allowed;
    }
    button {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: #1b5e20;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    /* Preview Section */
    #previewSection {
      margin-top: 30px;
      padding: 20px;
      background: var(--bg);
      border-radius: 10px;
      display: none;
    }
    #previewTable table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 10px;
      text-align: center;
      border: 1px solid var(--border);
    }
    th {
      background: var(--primary);
      font-weight: bold;
    }
    tr:nth-child(even) {
      background: #1a1a1a;
    }

    /* Message */
    #message {
      padding: 12px;
      margin: 15px 0;
      border-radius: 6px;
      text-align: center;
      font-weight: bold;
    }
    .success { background: #1a521a; color: #bbdefb; }
    .error { background: #521a1a; color: #ffcccb; }

    /* Export Button Style */
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .btn-secondary {
      background: #424242;
    }
    .btn-secondary:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìã Input Volume Blending</h1>
    </header>

    <div class="form-section">
      <div class="form-group">
        <label for="tanggal">Tanggal Produksi:</label>
        <input type="date" id="tanggal" required />
      </div>

      <div class="form-group">
        <label for="batch">Batch (contoh: 1-2, 5-6, dll):</label>
        <input type="text" id="batch" placeholder="Ketik batch secara manual" required />
      </div>

      <div class="form-group">
        <label for="varian">Varian:</label>
        <select id="varian" required>
          <option value="">-- Pilih Varian --</option>
          <optgroup label="JB Group">
            <option value="JB Mix GF (Non Repro)">JB Mix GF (Non Repro)</option>
            <option value="JB Glukosa SKJ Baru">JB Glukosa SKJ Baru</option>
          </optgroup>
          <optgroup label="BB Group">
            <option value="BB Mix GF">BB Mix GF</option>
            <option value="BB Glukosa SKJ Baru">BB Glukosa SKJ Baru</option>
          </optgroup>
          <optgroup label="SS Group">
            <option value="SS Mix GF (Non Repro)">SS Mix GF (Non Repro)</option>
            <option value="SS Mix GF (Repro)">SS Mix GF (Repro)</option>
          </optgroup>
          <optgroup label="MSD Group">
            <option value="MSD 80 Persen (Repro MSD)">MSD 80 Persen (Repro MSD)</option>
            <option value="MSD 80 Persen (Repro NR2)">MSD 80 Persen (Repro NR2)</option>
          </optgroup>
          <option value="NR2">NR2</option>
        </select>
      </div>

      <div class="form-group">
        <label for="grup">Grup:</label>
        <select id="grup" required>
          <option value="">-- Pilih Grup --</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="A/B">A/B</option>
          <option value="A/C">A/C</option>
          <option value="B/A">B/A</option>
          <option value="B/C">B/C</option>
          <option value="C/A">C/A</option>
          <option value="C/B">C/B</option>
        </select>
      </div>

      <div class="form-group">
        <label for="volAwal">Volume Awal (L):</label>
        <input type="number" id="volAwal" min="0" step="0.01" placeholder="Contoh: 10000.00" required />
      </div>

      <div class="form-group">
        <label for="volAkhir">Volume Akhir (L):</label>
        <input type="number" id="volAkhir" min="0" step="0.01" placeholder="Contoh: 9800.00" required />
      </div>

      <div class="form-group">
        <label for="air">Air (kg):</label>
        <input type="number" id="air" min="0" step="0.01" placeholder="Contoh: 200.00" required />
      </div>

      <div class="form-group">
        <label for="garam">Garam (kg):</label>
        <input type="number" id="garam" min="0" step="0.01" placeholder="Contoh: 50.00" required />
      </div>

      <!-- Kolom Otomatis -->
      <div class="form-group">
        <label>Selisih (L):</label>
        <input type="number" id="selisihL" readonly step="0.01" placeholder="Otomatis" />
      </div>

      <div class="form-group">
        <label>Selisih (kg):</label>
        <input type="number" id="selisihKg" readonly step="0.01" placeholder="Otomatis" />
      </div>

      <div class="form-group">
        <label>Total Adjustment (kg):</label>
        <input type="number" id="totalAdjustment" readonly step="0.01" placeholder="Otomatis" />
      </div>

      <div class="form-group">
        <label>Selisih Vol (Akhir) - Total Adjustment (kg):</label>
        <input type="number" id="selisihVolMinusAdj" readonly step="0.01" placeholder="Otomatis" />
      </div>

      <div class="form-group">
        <label>STD Vol Awal (L):</label>
        <input type="number" id="stdVolAwal" readonly step="0.01" placeholder="Otomatis" />
      </div>

      <div class="form-group">
        <label>Selisih Awal Blending Aktual STD (L):</label>
        <input type="number" id="selisihAwalBlendingStdL" readonly step="0.01" placeholder="Otomatis" />
      </div>

      <div class="form-group">
        <label>Selisih Awal Blending Aktual STD (Kg):</label>
        <input type="number" id="selisihAwalBlendingStdKg" readonly step="0.01" placeholder="Otomatis" />
      </div>

      <div class="btn-group">
        <button type="button" id="previewBtn">üîç Preview</button>
        <button type="button" id="exportPdfBtn" class="btn-secondary">üì• PDF</button>
        <button type="button" id="exportExcelBtn" class="btn-secondary">üìä Excel</button>
      </div>

      <button type="submit" id="submitBtn">üì§ Kirim ke Spreadsheet</button>

      <div id="message"></div>
    </div>

    <!-- Preview Section -->
    <div id="previewSection">
      <h3>üìä Preview Data</h3>
      <div id="previewTable"></div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const STD_VOL_AWAL = {
      "JB Mix GF (Non Repro)": { kg: 13.613, l: 9793 },
      "BB Mix GF": { kg: 13.997, l: 10070 },
      "SS Mix GF (Non Repro)": { kg: 11.461, l: 8245 },
      "SS Mix GF (Repro)": { kg: 12.574, l: 9046 },
      "JB Glukosa SKJ Baru": { kg: 13.947, l: 10034 },
      "BB Glukosa SKJ Baru": { kg: 14.665, l: 10550 },
      "MSD 80 Persen (Repro MSD)": { kg: 14.300, l: 10288 },
      "MSD 80 Persen (Repro NR2)": { kg: 13.922, l: 10016 },
      "NR2": { kg: 12.577, l: 9048 }
    };

    const STORAGE_KEY = 'blending_form_data_v2';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2GuEwFtq-PU-2RqzLL009ufyFPkOTsRAKrjuQjfEx-oAiZmWwmCnaMZw-TtBaolOv/exec';

    document.addEventListener('DOMContentLoaded', () => {
      setupAutoCalculations();
    });

    function setupAutoCalculations() {
      const inputs = ['volAwal', 'volAkhir', 'air', 'garam', 'varian'];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', calculateAll);
        }
      });
      calculateAll();
    }

    function calculateAll() {
      const volAwal = parseFloat(document.getElementById('volAwal').value) || 0;
      const volAkhir = parseFloat(document.getElementById('volAkhir').value) || 0;
      const air = parseFloat(document.getElementById('air').value) || 0;
      const garam = parseFloat(document.getElementById('garam').value) || 0;
      const varian = document.getElementById('varian').value;

      const selisihL = volAkhir - volAwal;
      document.getElementById('selisihL').value = selisihL.toFixed(2);

      const selisihKg = selisihL * 1.39;
      document.getElementById('selisihKg').value = selisihKg.toFixed(2);

      const totalAdjustment = air + garam;
      document.getElementById('totalAdjustment').value = totalAdjustment.toFixed(2);

      const selisihVolMinusAdj = selisihKg - totalAdjustment;
      document.getElementById('selisihVolMinusAdj').value = selisihVolMinusAdj.toFixed(2);

      let stdVolAwalL = 0;
      if (STD_VOL_AWAL[varian]) {
        stdVolAwalL = STD_VOL_AWAL[varian].l;
      }
      document.getElementById('stdVolAwal').value = stdVolAwalL.toFixed(2);

      const selisihAwalBlendingStdL = volAwal - stdVolAwalL;
      document.getElementById('selisihAwalBlendingStdL').value = selisihAwalBlendingStdL.toFixed(2);

      const selisihAwalBlendingStdKg = selisihAwalBlendingStdL * 1.39;
      document.getElementById('selisihAwalBlendingStdKg').value = selisihAwalBlendingStdKg.toFixed(2);
    }

    // === EKSPOR EXCEL (.xlsx) ===
    function exportToExcel() {
      const table = document.querySelector('#previewTable table');
      if (!table) {
        alert('‚ö†Ô∏è Klik "Preview" dulu untuk memuat data!');
        return;
      }

      const ws = XLSX.utils.table_to_sheet(table);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Blending_Data");
      XLSX.writeFile(wb, `Blending_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // === EKSPOR PDF (tetap tersedia) ===
    async function exportPreviewToPdf() {
      const tableEl = document.querySelector('#previewTable table');
      if (!tableEl || tableEl.rows.length <= 1) {
        alert('‚ö†Ô∏è Klik "Preview" dulu untuk memuat data!');
        return;
      }

      if (typeof window.jsPDF === 'undefined') {
        await new Promise((resolve) => {
          const s1 = document.createElement('script');
          s1.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          s1.onload = () => {
            const s2 = document.createElement('script');
            s2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js';
            s2.onload = resolve;
            document.head.appendChild(s2);
          };
          document.head.appendChild(s1);
        });
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape', 'mm', 'a4');
      const pageWidth = doc.internal.pageSize.width;

      let y = 15;
      const title = `Laporan Volume Blending - ${document.getElementById('varian').value || 'Varian'} - ${new Date().toISOString().slice(0,10)}`;
      doc.setFontSize(16);
      doc.text(title, pageWidth / 2, y, { align: 'center' });
      y += 15;

      doc.setFontSize(14);
      doc.text('üìã Detail Data', 20, y);
      y += 10;

      doc.autoTable({
        html: '#previewTable table',
        startY: y,
        theme: 'grid',
        headStyles: { fillColor: [46, 125, 50] },
        styles: { fontSize: 8 }
      });

      doc.save(`Laporan_Volume_Blending_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    // === PREVIEW ===
    document.getElementById('previewBtn').addEventListener('click', generatePreview);
    document.getElementById('exportPdfBtn').addEventListener('click', exportPreviewToPdf);
    document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
    document.getElementById('submitBtn').addEventListener('click', submitFormData);

    function generatePreview() {
      const tanggal = document.getElementById('tanggal').value ? new Date(document.getElementById('tanggal').value).toLocaleDateString('id-ID', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      }).replace(/\b\w/g, l => l.toUpperCase()) : 'Tanggal Belum Dipilih';

      const batch = document.getElementById('batch').value;
      const varian = document.getElementById('varian').value;
      const grup = document.getElementById('grup').value;
      const volAwal = document.getElementById('volAwal').value;
      const volAkhir = document.getElementById('volAkhir').value;
      const air = document.getElementById('air').value;
      const garam = document.getElementById('garam').value;
      const selisihL = document.getElementById('selisihL').value;
      const selisihKg = document.getElementById('selisihKg').value;
      const totalAdjustment = document.getElementById('totalAdjustment').value;
      const selisihVolMinusAdj = document.getElementById('selisihVolMinusAdj').value;
      const stdVolAwal = document.getElementById('stdVolAwal').value;
      const selisihAwalBlendingStdL = document.getElementById('selisihAwalBlendingStdL').value;
      const selisihAwalBlendingStdKg = document.getElementById('selisihAwalBlendingStdKg').value;

      let detailHTML = `<table><thead><tr>
        <th>Tanggal</th>
        <th>Batch</th>
        <th>Varian</th>
        <th>Grup</th>
        <th>Vol Awal (L)</th>
        <th>Vol Akhir (L)</th>
        <th>Selisih (L)</th>
        <th>Selisih (kg)</th>
        <th>Air (kg)</th>
        <th>Garam (kg)</th>
        <th>Total Adj (kg)</th>
        <th>Selisih Vol Akhir - Adj (kg)</th>
        <th>STD Vol Awal (L)</th>
        <th>Selisih Awal Blending Std (L)</th>
        <th>Selisih Awal Blending Std (Kg)</th>
      </tr></thead><tbody>
        <tr>
          <td>${tanggal}</td>
          <td>${batch}</td>
          <td>${varian}</td>
          <td>${grup}</td>
          <td>${volAwal}</td>
          <td>${volAkhir}</td>
          <td>${selisihL}</td>
          <td>${selisihKg}</td>
          <td>${air}</td>
          <td>${garam}</td>
          <td>${totalAdjustment}</td>
          <td>${selisihVolMinusAdj}</td>
          <td>${stdVolAwal}</td>
          <td>${selisihAwalBlendingStdL}</td>
          <td>${selisihAwalBlendingStdKg}</td>
        </tr>
      </tbody></table>`;

      document.getElementById('previewTable').innerHTML = detailHTML;
      document.getElementById('previewSection').style.display = 'block';
    }

    // === CLEAR FORM ===
    function clearForm() {
      document.getElementById('tanggal').value = '';
      document.getElementById('batch').value = '';
      document.getElementById('varian').value = '';
      document.getElementById('grup').value = '';
      document.getElementById('volAwal').value = '';
      document.getElementById('volAkhir').value = '';
      document.getElementById('air').value = '';
      document.getElementById('garam').value = '';

      // Kosongkan field otomatis
      document.getElementById('selisihL').value = '';
      document.getElementById('selisihKg').value = '';
      document.getElementById('totalAdjustment').value = '';
      document.getElementById('selisihVolMinusAdj').value = '';
      document.getElementById('stdVolAwal').value = '';
      document.getElementById('selisihAwalBlendingStdL').value = '';
      document.getElementById('selisihAwalBlendingStdKg').value = '';

      // Sembunyikan preview
      document.getElementById('previewSection').style.display = 'none';
    }

    // === KIRIM DATA ===
    function submitFormData() {
      const btn = document.getElementById('submitBtn');
      const original = btn.textContent;
      btn.textContent = 'Mengirim...';
      btn.disabled = true;

      const formData = new FormData();
      formData.append('tanggal', document.getElementById('tanggal').value);
      formData.append('batch', document.getElementById('batch').value);
      formData.append('varian', document.getElementById('varian').value);
      formData.append('grup', document.getElementById('grup').value);
      formData.append('volAwal', document.getElementById('volAwal').value);
      formData.append('volAkhir', document.getElementById('volAkhir').value);
      formData.append('air', document.getElementById('air').value);
      formData.append('garam', document.getElementById('garam').value);
      formData.append('selisihL', document.getElementById('selisihL').value);
      formData.append('selisihKg', document.getElementById('selisihKg').value);
      formData.append('totalAdjustment', document.getElementById('totalAdjustment').value);
      formData.append('selisihVolMinusAdj', document.getElementById('selisihVolMinusAdj').value);
      formData.append('stdVolAwal', document.getElementById('stdVolAwal').value);
      formData.append('selisihAwalBlendingStdL', document.getElementById('selisihAwalBlendingStdL').value);
      formData.append('selisihAwalBlendingStdKg', document.getElementById('selisihAwalBlendingStdKg').value);

      fetch(SCRIPT_URL, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
          if (d.status === "success") {
            document.getElementById('message').className = 'success';
            document.getElementById('message').textContent = '‚úÖ Data berhasil dikirim!';
            clearForm(); // üî• Auto-clear setelah sukses
          } else {
            throw new Error(d.message || 'Gagal kirim');
          }
        })
        .catch(e => {
          console.error(e);
          document.getElementById('message').className = 'error';
          document.getElementById('message').textContent = '‚ùå Gagal kirim data: ' + e.message;
        })
        .finally(() => {
          setTimeout(() => {
            document.getElementById('message').textContent = '';
          }, 3000);
          btn.textContent = original;
          btn.disabled = false;
        });
    }
  </script>
  
<!-- Kalkulator Modal -->
<div id="calculatorModal" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  justify-content: center;
  align-items: center;
">
  <div style="
    background: #1e1e1e;
    color: white;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 350px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.5);
  ">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3>Kalkulator</h3>
      <button id="closeCalc" style="
        background: #555; color: white; border: none; border-radius: 50%; width: 28px; height: 28px;
        font-weight: bold; cursor: pointer;
      ">√ó</button>
    </div>
    <input type="text" id="calcDisplay" readonly style="
      width: 100%; padding: 12px; background: #2a2a2a; color: white; border: 1px solid #444;
      border-radius: 6px; text-align: right; font-size: 18px; margin-bottom: 10px;
    " placeholder="0">
    <div id="calcButtons" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
  </div>
</div>

<style>
  /* Opsional: Tambahkan ikon kalkulator di input */
  .calc-trigger {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--primary);
    color: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .input-with-calc {
    position: relative;
  }
</style>

<script>
// === KALKULATOR LOGIC ===
let currentInputField = null;

function initCalculator() {
  const buttons = [
    '7', '8', '9', '/',
    '4', '5', '6', '*',
    '1', '2', '3', '-',
    '0', '.', '=', '+',
    'C'
  ];

  const container = document.getElementById('calcButtons');
  container.innerHTML = '';
  buttons.forEach(btn => {
    const el = document.createElement('button');
    el.textContent = btn;
    el.style = `
      padding: 12px; background: #333; color: white; border: 1px solid #444;
      border-radius: 6px; font-size: 16px; cursor: pointer;
    `;
    el.onclick = () => handleCalcClick(btn);
    container.appendChild(el);
  });
}

function handleCalcClick(value) {
  const display = document.getElementById('calcDisplay');
  if (value === 'C') {
    display.value = '';
  } else if (value === '=') {
    try {
      // Aman: hanya izinkan ekspresi matematika dasar
      const expr = display.value.replace(/[^-()\d/*+.]/g, '');
      const result = Function('"use strict"; return (' + expr + ')')();
      display.value = parseFloat(result.toFixed(4));
      
      // Isi ke field yang sedang aktif
      if (currentInputField) {
        currentInputField.value = display.value;
        calculateAll(); // update semua perhitungan otomatis
        document.getElementById('calculatorModal').style.display = 'none';
      }
    } catch (e) {
      display.value = 'Error';
      setTimeout(() => display.value = '', 1000);
    }
  } else {
    display.value += value;
  }
}

// Buka kalkulator dan simpan field tujuan
function openCalculator(fieldId) {
  currentInputField = document.getElementById(fieldId);
  document.getElementById('calcDisplay').value = currentInputField.value || '';
  document.getElementById('calculatorModal').style.display = 'flex';
  initCalculator();
}

// Tutup modal
document.getElementById('closeCalc').onclick = () => {
  document.getElementById('calculatorModal').style.display = 'none';
};

// Tutup saat klik luar modal
document.getElementById('calculatorModal').onclick = (e) => {
  if (e.target.id === 'calculatorModal') {
    document.getElementById('calculatorModal').style.display = 'none';
  }
};

// === INTEGRASI DENGAN FORM ===
// Tambahkan ikon kalkulator ke input Air & Garam
document.addEventListener('DOMContentLoaded', () => {
  ['air', 'garam'].forEach(id => {
    const input = document.getElementById(id);
    const wrapper = document.createElement('div');
    wrapper.className = 'input-with-calc';
    input.parentNode.insertBefore(wrapper, input);
    wrapper.appendChild(input);

    const calcBtn = document.createElement('button');
    calcBtn.className = 'calc-trigger';
    calcBtn.innerHTML = 'üßÆ';
    calcBtn.type = 'button';
    calcBtn.onclick = (e) => {
      e.preventDefault();
      openCalculator(id);
    };
    wrapper.appendChild(calcBtn);
  });
});
</script>
</body>
</html>


